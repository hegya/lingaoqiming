<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>小说阅读页</title>
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
			font-family: "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
		}
		body {
			display: flex;
			height: 100vh;
			overflow: hidden;
		}
		/* 移动端目录开关按钮（默认隐藏） */
		.mobile-toggle {
			display: none;
			position: fixed;
			top: 10px;
			left: 10px;
			z-index: 100;
			padding: 8px 12px;
			background: #0366d6;
			color: #fff;
			border: none;
			border-radius: 6px;
			cursor: pointer;
		}
		/* 遮罩层（移动端目录展开时显示） */
		.mask {
			display: none;
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0,0,0,0.3);
			z-index: 90;
		}
		/* 左侧目录栏 */
		.sidebar {
			width: 280px;
			min-width: 180px;
			max-width: calc(100% - 320px);
			background: #f6f8fa;
			border-right: 1px solid #e1e4e8;
			overflow-y: auto;
			padding: 16px;
			z-index: 95;
			transition: transform 0.3s ease;
		}
		/* 拖拽手柄 */
		.resize-handle {
			width: 4px;
			background: #e1e4e8;
			cursor: col-resize;
			transition: background 0.2s;
		}
		.resize-handle:hover {
			background: #0366d6;
		}
		/* 右侧内容区 */
		.content {
			flex: 1;
			padding: 24px;
			overflow-y: auto;
			background: #fff;
			font-size: 1.1em;
		}
		/* 目录样式（仿GitHub） */
		.toc {
			list-style: none;
		}
		.vol-item {
			cursor: pointer;
			padding: 4px 8px;
			border-radius: 3px;
			font-weight: 500;
			margin: 2px 0;
		}
		.vol-item:hover {
			background: #e6ebf1;
		}
		.vol-item.expanded::before { content: "▼ "; font-size: 0.8em; }
		.vol-item.collapsed::before { content: "▶ "; font-size: 0.8em; }
		.chapters-list {
			list-style: none;
			margin: 4px 0 8px 20px;
			display: none;
		}
		.vol-item.expanded + .chapters-list { display: block; }
		.chapter-item {
			padding: 4px 8px;
			border-radius: 3px;
			cursor: pointer;
			color: #0366d6;
			margin: 2px 0;
		}
		.chapter-item:hover {
			background: #e6ebf1;
			text-decoration: underline;
		}
		/* 内容区样式 */
		.chapter-title {
			margin-bottom: 20px;
			color: #24292e;
		}
		.chapter-content {
			line-height: 1.8;
			font-size: 16px;
			white-space: pre-wrap; /* 保留txt换行 */
			margin-bottom: 32px;
			color: #24292e;
		}
		.nav-buttons {
			display: flex;
			gap: 16px;
			justify-content: space-between;
		}
		.nav-btn {
			padding: 8px 16px;
			background: #0366d6;
			color: #fff;
			border: none;
			border-radius: 6px;
			cursor: pointer;
			font-size: 14px;
		}
		.nav-btn:disabled {
			background: #94a3b8;
			cursor: not-allowed;
		}
		/* 响应式适配（核心优化） */
		@media (max-width: 768px) {
			/* 移动端默认隐藏目录栏，移到视口左侧 */
			.sidebar {
				position: fixed;
				left: 0;
				top: 0;
				height: 100%;
				transform: translateX(-100%);
				width: 250px;
				max-width: 80%;
			}
			/* 显示移动端目录开关按钮 */
			.mobile-toggle {
				display: block;
			}
			/* 目录展开时显示遮罩 */
			.sidebar.show + .mask {
				display: block;
			}
			/* 目录展开时显示目录栏 */
			.sidebar.show {
				transform: translateX(0);
			}
			/* 移动端隐藏拖拽手柄 */
			.resize-handle {
				display: none;
			}
			/* 移动端内容区适配 */
			.content {
				padding: 16px;
				width: 100%;
			}
			.chapter-content { font-size: 15px; }
		}
	</style>
</head>
<body>
	<!-- 移动端目录开关按钮（新增） -->
	<button class="mobile-toggle" id="mobileToggle">☰ 目录</button>
	<!-- 左侧目录栏 -->
	<div class="sidebar" id="sidebar">
		<ul class="toc" id="toc"></ul>
	</div>
	<!-- 移动端遮罩层（新增） -->
	<div class="mask" id="mask"></div>
	<!-- 拖拽手柄 -->
	<div class="resize-handle" id="resizeHandle"></div>
	<!-- 右侧内容区 -->
	<div class="content" id="content">
		<h1>请选择左侧章节开始阅读</h1>
	</div>

	<script>
		// 步骤1：加载目录配置
		let tocData = [];
		let allChapters = []; // 扁平章节列表（用于上下翻页）

		async function init() {
			try {
				// 读取toc.json（需手动配置仓库的vol和章节路径）
				const res = await fetch('toc.json');
				tocData = await res.json();
				
				// 按vol数字排序（避免vol1、vol10、vol2的混乱）
				tocData.sort((a, b) => {
					const numA = parseInt(a.name.replace('vol', ''));
					const numB = parseInt(b.name.replace('vol', ''));
					return numA - numB;
				});

				// 生成扁平章节列表
				allChapters = tocData.flatMap(vol => 
					vol.chapters.map(chap => ({ ...chap, volName: vol.name }))
				);

				// 渲染左侧目录
				renderToc();
				// 初始化移动端目录开关（新增）
				initMobileToggle();
			} catch (err) {
				document.getElementById('content').innerHTML = `<p>目录加载失败：${err.message}</p>`;
			}
		}

		// 步骤2：渲染左侧目录
		function renderToc() {
			const tocEl = document.getElementById('toc');
			tocData.forEach(vol => {
				// 渲染vol项（可折叠）
				const volEl = document.createElement('li');
				volEl.className = 'vol-item collapsed';
				volEl.textContent = vol.name;
				tocEl.appendChild(volEl);

				// 渲染章节列表
				const chaptersEl = document.createElement('ul');
				chaptersEl.className = 'chapters-list';
				vol.chapters.forEach(chap => {
					const chapEl = document.createElement('li');
					chapEl.className = 'chapter-item';
					chapEl.textContent = chap.name;
					chapEl.onclick = () => {
						loadChapter(chap.path);
						// 移动端点击章节后自动收起目录（新增）
						if (window.innerWidth <= 768) {
							document.getElementById('sidebar').classList.remove('show');
						}
					};
					chaptersEl.appendChild(chapEl);
				});
				tocEl.appendChild(chaptersEl);

				// 折叠/展开逻辑
				volEl.onclick = () => {
					volEl.classList.toggle('expanded');
					volEl.classList.toggle('collapsed');
				};
			});
		}

		// 步骤3：移动端目录开关逻辑（新增）
		function initMobileToggle() {
			const toggleBtn = document.getElementById('mobileToggle');
			const sidebar = document.getElementById('sidebar');
			const mask = document.getElementById('mask');

			// 点击按钮切换目录显示/隐藏
			toggleBtn.addEventListener('click', () => {
				sidebar.classList.toggle('show');
			});

			// 点击遮罩隐藏目录
			mask.addEventListener('click', () => {
				sidebar.classList.remove('show');
			});
		}

		// 步骤4：拖拽调整目录宽度（仅桌面端生效）
		const sidebar = document.getElementById('sidebar');
		const resizeHandle = document.getElementById('resizeHandle');
		let isResizing = false;

		resizeHandle.addEventListener('mousedown', () => {
			isResizing = true;
			document.addEventListener('mousemove', resizeSidebar);
			document.addEventListener('mouseup', stopResize);
		});

		function resizeSidebar(e) {
			if (!isResizing || window.innerWidth <= 768) return; // 移动端禁用拖拽
			const newWidth = e.clientX;
			if (newWidth >= sidebar.minWidth && newWidth <= sidebar.maxWidth) {
				sidebar.style.width = `${newWidth}px`;
			}
		}

		function stopResize() {
			isResizing = false;
			document.removeEventListener('mousemove', resizeSidebar);
		}

		// 步骤5：加载章节内容+上下翻页（核心优化：翻页后滚动到顶部）
		async function loadChapter(path) {
			try {
				const res = await fetch(path);
				const content = await res.text();
				const contentEl = document.getElementById('content');

				// 找到当前章节的索引
				const currIdx = allChapters.findIndex(chap => chap.path === path);
				const prevChap = allChapters[currIdx - 1];
				const nextChap = allChapters[currIdx + 1];

				// 渲染内容
				contentEl.innerHTML = `
					<h2 class="chapter-title">${allChapters[currIdx].volName} · ${allChapters[currIdx].name}</h2>
					<div class="chapter-content">${content}</div>
					<div class="nav-buttons">
						<button class="nav-btn" ${!prevChap ? 'disabled' : ''}
							onclick="loadChapter('${prevChap?.path || ''}')">
							上一章
						</button>
						<button class="nav-btn" ${!nextChap ? 'disabled' : ''}
							onclick="loadChapter('${nextChap?.path || ''}')">
							下一章
						</button>
					</div>
				`;

				// 核心优化：加载章节后自动滚动到内容区顶部
				contentEl.scrollTop = 0;
				// 同时确保整个页面也滚动到顶部（兼容不同浏览器）
				window.scrollTo(0, 0);
			} catch (err) {
				contentEl.innerHTML = `<p>章节加载失败：${err.message}</p>`;
			}
		}

		// 初始化页面
		init();
	</script>
</body>
</html>
