<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>ä¸´é«˜å¯æ˜é˜…è¯»</title>
	<link rel="stylesheet" type="text/css" href="./style.css"/>
	<script type="text/javascript" src="./chapters.js"></script>
</head>
<body>
	<!-- å¤´éƒ¨ -->
	<header>
		<h1>ä¸´é«˜å¯æ˜</h1>
	</header>

	<!-- èœå•åˆ‡æ¢æŒ‰é’® -->
	<button class="menu-toggle" id="menuToggle">â˜°</button>

	<!-- é®ç½©å±‚ -->
	<div class="overlay" id="overlay"></div>

	<!-- ä¾§è¾¹æ  -->
	<div class="sidebar" id="sidebar">
		<h2>å·åˆ—è¡¨</h2>
		<ul id="volumeList"></ul>

		<h2>æœ€è¿‘é˜…è¯»</h2>
		<ul id="recentList"></ul>
	</div>

	<!-- ä¸»å†…å®¹åŒº -->
	<div class="main-content" id="mainContent">
		<div class="chapter-content" id="chapterContent">
			<h2 class="chapter-title">æ¬¢è¿ä½¿ç”¨ä¸´é«˜å¯æ˜é˜…è¯»</h2>
			<p>è¿™æ˜¯ä¸€ä¸ªç®€å•çš„å°è¯´é˜…è¯»åº”ç”¨ï¼Œä¸“ä¸ºã€Šä¸´é«˜å¯æ˜ã€‹è®¾è®¡ã€‚ä½ å¯ä»¥å°†æ¯ç« å†…å®¹ä¿å­˜ä¸ºç‹¬ç«‹çš„txtæ–‡ä»¶ï¼Œå¹¶é€šè¿‡ç›®å½•ç»“æ„ç»„ç»‡å®ƒä»¬ã€‚</p>
			<p>åº”ç”¨ç‰¹ç‚¹ï¼š</p>
			<ul>
				<li>æ”¯æŒæŒ‰å·å’Œç« èŠ‚ç»„ç»‡å°è¯´å†…å®¹</li>
				<li>è®°ä½æœ€è¿‘é˜…è¯»ä½ç½®</li>
				<li>æ”¯æŒå¤šç§é˜…è¯»æ¨¡å¼å’Œå­—ä½“è®¾ç½®</li>
				<li>å®Œå…¨ç¦»çº¿ä½¿ç”¨</li>
			</ul>
		</div>

		<div class="chapter-nav">
			<button id="prevChapter" disabled>ä¸Šä¸€ç« </button>
			<button id="nextChapter" disabled>ä¸‹ä¸€ç« </button>
		</div>
	</div>

	<!-- è®¾ç½®é¢æ¿ -->
	<div class="settings-panel" id="settingsPanel">
		<div class="settings-header">
			<h3>é˜…è¯»è®¾ç½®</h3>
			<button class="close-settings" id="closeSettings">Ã—</button>
		</div>

		<div class="setting-item">
			<label for="fontSize">å­—ä½“å¤§å°</label>
			<select id="fontSize">
				<option value="14">å°</option>
				<option value="16" selected>ä¸­</option>
				<option value="18">å¤§</option>
				<option value="20">è¶…å¤§</option>
			</select>
		</div>

		<div class="setting-item">
			<label for="lineHeight">è¡Œé—´è·</label>
			<select id="lineHeight">
				<option value="1.5">å°</option>
				<option value="1.8" selected>ä¸­</option>
				<option value="2.0">å¤§</option>
				<option value="2.2">è¶…å¤§</option>
			</select>
		</div>

		<div class="setting-item">
			<label>é˜…è¯»ä¸»é¢˜</label>
			<div class="theme-options" style="display: flex; gap: 0.5rem;">
				<button class="theme-btn" data-theme="light" style="background-color: #f8f5f0; width: 30px; height: 30px; border: 2px solid #8B4513;"></button>
				<button class="theme-btn" data-theme="dark" style="background-color: #1a1a1a; width: 30px; height: 30px; border: 2px solid transparent;"></button>
			</div>
		</div>

		<button class="save-settings" id="saveSettings">ä¿å­˜è®¾ç½®</button>
	</div>

	<!-- é˜…è¯»è®¾ç½®æŒ‰é’® -->
	<div class="reading-settings">
		<button id="themeToggle">ğŸŒ™</button>
		<button id="openSettings">âš™ï¸</button>
	</div>

	<script>
		// å½“å‰é˜…è¯»çŠ¶æ€
		let currentChapter = null;
		let currentVolume = null;

		// é˜…è¯»è®¾ç½®
		const readingSettings = {
			fontSize: 16,
			lineHeight: 1.8,
			theme: "light",
			indentation: 2
		};

		// DOMå…ƒç´ 
		const sidebar = document.getElementById('sidebar');
		const menuToggle = document.getElementById('menuToggle');
		const overlay = document.getElementById('overlay');
		const volumeList = document.getElementById('volumeList');
		const recentList = document.getElementById('recentList');
		const chapterContent = document.getElementById('chapterContent');
		const prevChapter = document.getElementById('prevChapter');
		const nextChapter = document.getElementById('nextChapter');
		const themeToggle = document.getElementById('themeToggle');
		const openSettings = document.getElementById('openSettings');
		const settingsPanel = document.getElementById('settingsPanel');
		const closeSettings = document.getElementById('closeSettings');
		const saveSettings = document.getElementById('saveSettings');
		const fontSizeSelect = document.getElementById('fontSize');
		const lineHeightSelect = document.getElementById('lineHeight');
		const themeBtns = document.querySelectorAll('.theme-btn');
		const indentationSelect = document.getElementById('indentation');

		// åˆå§‹åŒ–åº”ç”¨
		function initApp() {
			// åŠ è½½ä¿å­˜çš„è®¾ç½®
			loadSettings();

			// åº”ç”¨ä¿å­˜çš„ä¸»é¢˜
			applyTheme(readingSettings.theme);

			// æ¸²æŸ“å·åˆ—è¡¨
			renderVolumeList();

			// æ¸²æŸ“æœ€è¿‘é˜…è¯»åˆ—è¡¨
			renderRecentList();

			// ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
			bindEventListeners();

			// æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„é˜…è¯»ä½ç½®
			const savedPosition = localStorage.getItem('currentReadingPosition');
			if (savedPosition) {
				const { volumeId, chapterId } = JSON.parse(savedPosition);
				loadChapter(volumeId, chapterId);
			}
		}

		// æ¸²æŸ“å·åˆ—è¡¨
		function renderVolumeList() {
			volumeList.innerHTML = '';

			novelStructure.volumes.forEach(volume => {
				const volumeItem = document.createElement('div');
				volumeItem.className = 'volume-item';

				const volumeTitle = document.createElement('div');
				volumeTitle.className = 'volume-title';
				volumeTitle.innerHTML = `<span>${volume.title}</span>`;
				volumeTitle.dataset.volumeId = volume.id;

				const chapterList = document.createElement('ul');
				chapterList.className = 'chapter-list';
				chapterList.dataset.volumeId = volume.id;

				volume.chapters.forEach(chapter => {
					const chapterItem = document.createElement('li');
					chapterItem.textContent = chapter.title;
					chapterItem.dataset.volumeId = volume.id;
					chapterItem.dataset.chapterId = chapter.id;
					chapterItem.style.cursor = 'pointer';
					chapterItem.style.padding = '0.25rem 0';
					chapterItem.addEventListener('click', () => {
						loadChapter(volume.id, chapter.id);
						closeSidebar();
					});

					chapterList.appendChild(chapterItem);
				});

				// æŠ˜å /å±•å¼€å·
				volumeTitle.addEventListener('click', () => {
					const isExpanded = chapterList.classList.contains('visible');

					if (isExpanded) {
						chapterList.classList.remove('visible');
						volumeTitle.classList.remove('expanded');
					} else {
						chapterList.classList.add('visible');
						volumeTitle.classList.add('expanded');
					}

					// ä¿å­˜å·çš„å±•å¼€çŠ¶æ€
					localStorage.setItem(`volume_${volume.id}_expanded`, isExpanded ? 'false' : 'true');
				});

				// æ£€æŸ¥æ˜¯å¦ä¿å­˜äº†å±•å¼€çŠ¶æ€
				const savedExpanded = localStorage.getItem(`volume_${volume.id}_expanded`);
				if (savedExpanded === 'true') {
					chapterList.classList.add('visible');
					volumeTitle.classList.add('expanded');
				}

				volumeItem.appendChild(volumeTitle);
				volumeItem.appendChild(chapterList);
				volumeList.appendChild(volumeItem);
			});
		}

		// æ¸²æŸ“æœ€è¿‘é˜…è¯»åˆ—è¡¨
		function renderRecentList() {
			recentList.innerHTML = '';

			const recentChapters = JSON.parse(localStorage.getItem('recentChapters') || '[]');

			if (recentChapters.length === 0) {
				const emptyItem = document.createElement('li');
				emptyItem.textContent = 'æš‚æ— æœ€è¿‘é˜…è¯»è®°å½•';
				emptyItem.style.color = '#666';
				emptyItem.style.fontSize = '0.9rem';
				recentList.appendChild(emptyItem);
				return;
			}

			recentChapters.forEach(({ volumeId, chapterId }) => {
				const volume = findVolumeById(volumeId);
				const chapter = findChapterById(volumeId, chapterId);

				if (volume && chapter) {
					const recentItem = document.createElement('li');
					recentItem.innerHTML = `
						<div>${chapter.title}</div>
						<div style="color: #666; font-size: 0.9rem;">${volume.title}</div>
					`;
					recentItem.dataset.volumeId = volumeId;
					recentItem.dataset.chapterId = chapterId;
					recentItem.style.cursor = 'pointer';
					recentItem.style.padding = '0.5rem 0';
					recentItem.addEventListener('click', () => {
						loadChapter(volumeId, chapterId);
						closeSidebar();
					});

					recentList.appendChild(recentItem);
				}
			});
		}

		// æŸ¥æ‰¾å·
		function findVolumeById(volumeId) {
			return novelStructure.volumes.find(volume => volume.id === volumeId);
		}

		// æŸ¥æ‰¾ç« èŠ‚
		function findChapterById(volumeId, chapterId) {
			const volume = findVolumeById(volumeId);
			return volume?.chapters.find(chapter => chapter.id === chapterId);
		}

		// åŠ è½½ç« èŠ‚å†…å®¹
		function loadChapter(volumeId, chapterId) {
			const volume = findVolumeById(volumeId);
			const chapter = findChapterById(volumeId, chapterId);

			if (!volume || !chapter) {
				alert('ç« èŠ‚æœªæ‰¾åˆ°');
				return;
			}

			// æ›´æ–°å½“å‰é˜…è¯»çŠ¶æ€
			currentVolume = volume;
			currentChapter = chapter;

			// æ˜¾ç¤ºåŠ è½½ä¸­
			chapterContent.innerHTML = `
				<h2 class="chapter-title">åŠ è½½ä¸­...</h2>
			`;

			// æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
			updateNavigationButtons();

			// ä»æ–‡ä»¶åŠ è½½ç« èŠ‚å†…å®¹
			const filePath = `${volume.path}/${chapter.path}`;
			fetch(filePath)
				.then(response => {
					if (!response.ok) {
						throw new Error('ç« èŠ‚å†…å®¹åŠ è½½å¤±è´¥');
					}
					return response.text();
				})
				.then(content => {
					// æ˜¾ç¤ºç« èŠ‚å†…å®¹
					chapterContent.innerHTML = `
						<h2 class="chapter-title">${chapter.title}</h2>
						<div id="chapterText" class="chapter-text">${formatChapterContent(content)}</div>
					`;

					// åº”ç”¨é˜…è¯»è®¾ç½®
					applyReadingSettings();

					// ä¿å­˜é˜…è¯»ä½ç½®
					saveReadingPosition();

					// æ·»åŠ åˆ°æœ€è¿‘é˜…è¯»
					addToRecent(volumeId, chapterId);

					// å±•å¼€å½“å‰å·
					expandCurrentVolume(volumeId);
				})
				.catch(error => {
					console.error('åŠ è½½ç« èŠ‚å¤±è´¥:', error);
					chapterContent.innerHTML = `
						<h2 class="chapter-title">åŠ è½½å¤±è´¥</h2>
						<p>æ— æ³•åŠ è½½è¯¥ç« èŠ‚å†…å®¹ï¼Œè¯·ç¡®ä¿æ–‡ä»¶è·¯å¾„æ­£ç¡®ã€‚</p>
						<p>é”™è¯¯ä¿¡æ¯: ${error.message}</p>
					`;
				});
		}

		// å±•å¼€å½“å‰å·
		function expandCurrentVolume(volumeId) {
			const volumeTitle = document.querySelector(`.volume-title[data-volume-id="${volumeId}"]`);
			const chapterList = document.querySelector(`.chapter-list[data-volume-id="${volumeId}"]`);

			if (volumeTitle && chapterList) {
				chapterList.classList.add('visible');
				volumeTitle.classList.add('expanded');
				localStorage.setItem(`volume_${volumeId}_expanded`, 'true');
			}
		}

		// æ ¼å¼åŒ–ç« èŠ‚å†…å®¹
		function formatChapterContent(content) {
			// å°†æ–‡æœ¬æŒ‰æ®µè½åˆ†å‰²ï¼ˆç©ºè¡Œåˆ†éš”ï¼‰
			const paragraphs = content.split(/\n\s*\n/).filter(paragraph => paragraph.trim() !== '');

			// ç”¨<p>æ ‡ç­¾åŒ…è£¹æ¯ä¸ªæ®µè½
			return paragraphs.map(paragraph => `<p>${paragraph}</p>`).join('');
		}

		// æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
		function updateNavigationButtons() {
			if (!currentVolume || !currentChapter) {
				prevChapter.disabled = true;
				nextChapter.disabled = true;
				return;
			}

			const currentIndex = currentVolume.chapters.findIndex(ch => ch.id === currentChapter.id);

			// ä¸Šä¸€ç« æŒ‰é’®
			if (currentIndex > 0) {
				prevChapter.disabled = false;
				prevChapter.dataset.volumeId = currentVolume.id;
				prevChapter.dataset.chapterId = currentVolume.chapters[currentIndex - 1].id;
			} else {
				prevChapter.disabled = true;
				prevChapter.removeAttribute('data-volume-id');
				prevChapter.removeAttribute('data-chapter-id');
			}

			// ä¸‹ä¸€ç« æŒ‰é’®
			if (currentIndex < currentVolume.chapters.length - 1) {
				nextChapter.disabled = false;
				nextChapter.dataset.volumeId = currentVolume.id;
				nextChapter.dataset.chapterId = currentVolume.chapters[currentIndex + 1].id;
			} else {
				// æ£€æŸ¥æ˜¯å¦æœ‰ä¸‹ä¸€å·
				const nextVolumeIndex = novelStructure.volumes.findIndex(v => v.id === currentVolume.id) + 1;
				if (nextVolumeIndex < novelStructure.volumes.length) {
					nextChapter.disabled = false;
					nextChapter.dataset.volumeId = novelStructure.volumes[nextVolumeIndex].id;
					nextChapter.dataset.chapterId = novelStructure.volumes[nextVolumeIndex].chapters[0].id;
				} else {
					nextChapter.disabled = true;
					nextChapter.removeAttribute('data-volume-id');
					nextChapter.removeAttribute('data-chapter-id');
				}
			}
		}

		// æ‰“å¼€ä¾§è¾¹æ 
		function openSidebar() {
			sidebar.classList.add('active');
			overlay.classList.add('active');
		}

		// å…³é—­ä¾§è¾¹æ 
		function closeSidebar() {
			sidebar.classList.remove('active');
			overlay.classList.remove('active');
		}

		// åˆ‡æ¢ä¸»é¢˜
		function toggleTheme() {
			readingSettings.theme = readingSettings.theme === 'light' ? 'dark' : 'light';
			applyTheme(readingSettings.theme);
			saveSettingsToStorage();
		}

		// åº”ç”¨ä¸»é¢˜
		function applyTheme(theme) {
			const body = document.body;

			if (theme === 'light') {
				body.classList.remove('dark-mode');
				themeToggle.textContent = 'ğŸŒ™';
			} else {
				body.classList.add('dark-mode');
				themeToggle.textContent = 'â˜€ï¸';
			}

			// æ›´æ–°ä¸»é¢˜æŒ‰é’®çŠ¶æ€
			themeBtns.forEach(btn => {
				if (btn.dataset.theme === theme) {
					btn.style.borderColor = '#8B4513';
				} else {
					btn.style.borderColor = 'transparent';
				}
			});
		}

		// åº”ç”¨é˜…è¯»è®¾ç½®
		function applyReadingSettings() {
			const chapterText = document.getElementById('chapterText');
			if (chapterText) {
				chapterText.style.fontSize = `${readingSettings.fontSize}px`;
				chapterText.style.lineHeight = readingSettings.lineHeight;
			}

			// æ›´æ–°è®¾ç½®é¢æ¿
			fontSizeSelect.value = readingSettings.fontSize;
			lineHeightSelect.value = readingSettings.lineHeight;
			indentationSelect.value = readingSettings.indentation;
		}

		// ä¿å­˜é˜…è¯»è®¾ç½®
		function saveSettingsToStorage() {
			localStorage.setItem('readingSettings', JSON.stringify(readingSettings));
		}

		// åŠ è½½ä¿å­˜çš„è®¾ç½®
		function loadSettings() {
			const savedSettings = localStorage.getItem('readingSettings');
			if (savedSettings) {
				Object.assign(readingSettings, JSON.parse(savedSettings));
			}
		}

		// ä¿å­˜é˜…è¯»ä½ç½®
		function saveReadingPosition() {
			if (currentVolume && currentChapter) {
				localStorage.setItem('currentReadingPosition', JSON.stringify({
					volumeId: currentVolume.id,
					chapterId: currentChapter.id
				}));
			}
		}

		// æ·»åŠ åˆ°æœ€è¿‘é˜…è¯»
		function addToRecent(volumeId, chapterId) {
			let recentChapters = JSON.parse(localStorage.getItem('recentChapters') || '[]');

			// æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
			const index = recentChapters.findIndex(
				item => item.volumeId === volumeId && item.chapterId === chapterId
			);

			// å¦‚æœå­˜åœ¨ï¼Œç§»é™¤
			if (index !== -1) {
				recentChapters.splice(index, 1);
			}

			// æ·»åŠ åˆ°å¼€å¤´
			recentChapters.unshift({ volumeId, chapterId });

			// é™åˆ¶é•¿åº¦ä¸º5
			if (recentChapters.length > 5) {
				recentChapters.pop();
			}

			// ä¿å­˜
			localStorage.setItem('recentChapters', JSON.stringify(recentChapters));

			// é‡æ–°æ¸²æŸ“æœ€è¿‘é˜…è¯»åˆ—è¡¨
			renderRecentList();
		}

		// ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
		function bindEventListeners() {
			// ä¾§è¾¹æ åˆ‡æ¢
			menuToggle.addEventListener('click', openSidebar);
			overlay.addEventListener('click', closeSidebar);

			// å¯¼èˆªæŒ‰é’®
			prevChapter.addEventListener('click', () => {
				if (!prevChapter.disabled) {
					loadChapter(parseInt(prevChapter.dataset.volumeId), parseInt(prevChapter.dataset.chapterId));
				}
			});

			nextChapter.addEventListener('click', () => {
				if (!nextChapter.disabled) {
					loadChapter(parseInt(nextChapter.dataset.volumeId), parseInt(nextChapter.dataset.chapterId));
				}
			});

			// ä¸»é¢˜åˆ‡æ¢
			themeToggle.addEventListener('click', toggleTheme);

			// è®¾ç½®é¢æ¿
			openSettings.addEventListener('click', () => {
				settingsPanel.classList.add('active');
				applyReadingSettings();
			});

			closeSettings.addEventListener('click', () => {
				settingsPanel.classList.remove('active');
			});

			// ä¿å­˜è®¾ç½®
			saveSettings.addEventListener('click', () => {
				readingSettings.fontSize = parseInt(fontSizeSelect.value);
				readingSettings.lineHeight = parseFloat(lineHeightSelect.value);

				applyReadingSettings();
				saveSettingsToStorage();

				settingsPanel.classList.remove('active');
			});

			// ä¸»é¢˜æŒ‰é’®
			themeBtns.forEach(btn => {
				btn.addEventListener('click', () => {
					readingSettings.theme = btn.dataset.theme;
					applyTheme(readingSettings.theme);
					saveSettingsToStorage();
				});
			});
		}

		// åˆå§‹åŒ–åº”ç”¨
		document.addEventListener('DOMContentLoaded', initApp);
	</script>
</body>
</html>

