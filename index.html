<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>临高启明</title>
	<link href="./main.css" rel="stylesheet" type="text/css" />
</head>
<body>
	<!-- 左侧目录栏 -->
	<div class="sidebar" id="sidebar">
		<ul class="toc" id="toc"></ul>
	</div>
	<!-- 移动端遮罩层 -->
	<div class="mask" id="mask"></div>
	<!-- 右侧内容区 -->
	<div class="content" id="content">
		<!-- 初始标题（未选章节时） -->
		<h3 class="chapter-title">
			<button class="mobile-toggle" id="mobileToggle">☰ 目录</button>
		</h3>
		<img src="./lgqm.webp" width="60%">
	</div>

	<script>
		let tocData = [];
		let allChapters = [];

		async function init() {
			try {
				const res = await fetch('./toc.json');
				tocData = await res.json();
				tocData.sort((a, b) => {
					const numA = parseInt(a.name.replace('vol', ''));
					const numB = parseInt(b.name.replace('vol', ''));
					return numA - numB;
				});
				allChapters = tocData.flatMap(vol => 
					vol.chapters.map(chap => ({ ...chap, volName: vol.name }))
				);
				renderToc();
				initMobileToggle();
			} catch (err) {
				document.getElementById('content').innerHTML = `
					<h2 class="chapter-title">
						<button class="mobile-toggle" id="mobileToggle">☰ 目录</button>
					</h2>
					目录加载失败：${err.message}
				`;
			}
		}

		// 渲染目录（单一vol展开）
		function renderToc() {
			const tocEl = document.getElementById('toc');
			tocData.forEach(vol => {
				const volEl = document.createElement('li');
				volEl.className = 'vol-item collapsed';
				volEl.textContent = vol.name;
				tocEl.appendChild(volEl);

				const chaptersEl = document.createElement('ul');
				chaptersEl.className = 'chapters-list';
				vol.chapters.forEach(chap => {
					const chapEl = document.createElement('li');
					chapEl.className = 'chapter-item';
					chapEl.textContent = chap.name;
					chapEl.onclick = () => {
						loadChapter(chap.path);
						if (window.innerWidth <= 1024) {
							document.getElementById('sidebar').classList.remove('show');
						}
					};
					chaptersEl.appendChild(chapEl);
				});
				tocEl.appendChild(chaptersEl);

				// 单一vol展开逻辑
				volEl.onclick = () => {
					document.querySelectorAll('.vol-item.expanded').forEach(item => {
						item.classList.remove('expanded');
						item.classList.add('collapsed');
					});
					volEl.classList.remove('collapsed');
					volEl.classList.add('expanded');
				};
			});
		}

		// 移动端目录开关
		function initMobileToggle() {
			const toggleBtn = document.getElementById('mobileToggle');
			const sidebar = document.getElementById('sidebar');
			const mask = document.getElementById('mask');
			toggleBtn.addEventListener('click', () => sidebar.classList.toggle('show'));
			mask.addEventListener('click', () => sidebar.classList.remove('show'));
		}

		// 加载章节内容（标题栏带目录按钮）
		async function loadChapter(path) {
			try {
				const res = await fetch(path);
				const content = await res.text();
				const paragraphs = content.split('\n').filter(p => p.trim() !== '');
				const contentHtml = paragraphs.map(p => `<p>${p}</p>`).join('');
				const contentEl = document.getElementById('content');
				const currIdx = allChapters.findIndex(chap => chap.path === path);
				const prevChap = allChapters[currIdx - 1];
				const nextChap = allChapters[currIdx + 1];

				// 渲染带目录按钮的标题栏
				contentEl.innerHTML = `
					<h2 class="chapter-title">
						${allChapters[currIdx].volName}<br>${allChapters[currIdx].name}
						<button class="mobile-toggle" id="mobileToggle">☰ 目录</button>
					</h2>
					<div class="chapter-content">${contentHtml}</div>
					<div class="nav-buttons">
						<button class="nav-btn" ${!prevChap ? 'disabled' : ''}
							onclick="loadChapter('${prevChap?.path || ''}')">
							上一章
						</button>
						<button class="nav-btn" ${!nextChap ? 'disabled' : ''}
							onclick="loadChapter('${nextChap?.path || ''}')">
							下一章
						</button>
					</div>
				`;
				// 重新绑定目录按钮事件（内容刷新后）
				initMobileToggle();
				contentEl.scrollTop = 0;
				window.scrollTo(0, 0);
			} catch (err) {
				contentEl.innerHTML = `
					<h2 class="chapter-title">
						<button class="mobile-toggle" id="mobileToggle">☰ 目录</button>
					</h2>
					章节加载失败：${err.message}
				`;
			}
		}

		init();
	</script>
</body>
</html>
